Разворачиваем запускаем:
![](Pasted%20image%2020251226151938.png)
Посмотрим из чего состоит кластер в patroni:
![](Pasted%20image%2020251226152228.png)
видим три ноды: один лидер и две реплики
![](Pasted%20image%2020251226152532.png)
Видим, что активна одна мастер нода и две реплики, значит HAProxy корректно взаимодействует с Patroni и динамически маршрутизирует трафик.
Прольем скрипт на мастер ноду и на реплику:
![](Pasted%20image%2020251226155157.png)
На 5001 выдает ошибку о ридонли
![](Pasted%20image%2020251226155231.png)
А на 5002 норм, значит в бухгалтерии все перепутали и на 5001 доступны реплики, а на 5002 - мастер.
Запускаем скрипт, видим логи об успешных чтениях/записях:
![](Pasted%20image%2020251226160450.png)
![](Pasted%20image%2020251226160756.png)
Чтение и запись работают через HAProxy, приложение не знает о реальной топологии кластера.
Попробуем поотключать ноды Patroni, для начала выключим одну из реплик:
![](Pasted%20image%2020251226161052.png)
Скрипт выполняется дальше без ошибок
![](Pasted%20image%2020251226161124.png)
![](Pasted%20image%2020251226161159.png)
Нода перестала отображаться в HAProxy, лидер не изменился
Теперь вернем отключенную реплику обратно и выключим мастер ноду:
![](Pasted%20image%2020251226161452.png)
![](Pasted%20image%2020251226161522.png)
Видим, что лидер сменился автоматически, скрипт выпал в ошибку тк соединение с БД было закрыто:
![](Pasted%20image%2020251226161623.png)
Нода отвалилась окончательно, перезапустим скрипт
![](Pasted%20image%2020251226161751.png)
![](Pasted%20image%2020251226161800.png)
Кластер работает
Теперь отключим еще одну реплику:
![](Pasted%20image%2020251226162022.png)

![](Pasted%20image%2020251226162003.png)

![](Pasted%20image%2020251226162106.png)
Скрипт работает, БД также продолжает работу без реплик
Поднимем все ноды Patroni обратно, начнем отключать ноды etcd:
![](Pasted%20image%2020251226162638.png)
![](Pasted%20image%2020251226162649.png)
![](Pasted%20image%2020251226162704.png)
Все работает, etcd кластер остается доступен (есть кворум)
Отключим еще одну:
![](Pasted%20image%2020251226162910.png)
![](Pasted%20image%2020251226162852.png)
![](Pasted%20image%2020251226162922.png)
Все сломалось, Patroni перестал работать, мастер нода отвалились в реплику. Аналогично кафке, при потере 2/3 нод etcd теряется кворум и дальнейшие failoverы невозможны.
Поднимем все ноды etcd обратно, попробуем отключить HAProxy:
![](Pasted%20image%2020251226163252.png)
![](Pasted%20image%2020251226163320.png)
![](Pasted%20image%2020251226163334.png)
После перезапуска работа приложения восстановилась автоматически без перезапуска.
Теперь HAProxy:
![](Pasted%20image%2020251226163509.png)

![](Pasted%20image%2020251226163452.png)

Выключив его мы потеряли точку входа, соответственно приложение не может работать корректно, при этом БД жива.

К сожалению, про графану я прочитал уже только после того как выполнил задание, поэтому без нее;(

Делаем вывод - HAProxy является SPOF в текущей схеме, для решения этой проблемы можно иметь несколько HAProxy и переключаться между ними через keepalived, либо использовать Kubernetes LoadBalancer